# Litgloss - Feature & Behavior Reference

Pronunciation-focused glossary app for Whitefriars 2026.

## Tech Stack

- **Runtime**: React 19.1 with Vite 7.1, no routing library
- **Data**: Firebase Firestore (collection: `terms`) + Firebase Storage (audio cache)
- **Styling**: Tailwind CSS 3.3 with CSS variable theming (light/dark), `tailwindcss-animate`
- **UI primitives**: Radix UI (alert-dialog, scroll-area, slot), `class-variance-authority` for button variants
- **Notifications**: `sonner` toast library (themed via `next-themes`)
- **Icons**: `lucide-react`
- **Font**: Inter (loaded via Google Fonts in index.html)
- **External APIs**: Free Dictionary API (IPA), ElevenLabs (text-to-speech)

## Architecture

Single-component app (`App.jsx`). All state lives in one `useState` object `s`, updated via a helper `update(u)` that accepts either an object (shallow merge) or a function (receives previous state). No routing library; views are controlled by `s.view` (`'list'` | `'detail'` | `'import'`).

**Stale State Protection**: A `useRef` named `sRef` is maintained to always hold the most current version of the state. This is critical for asynchronous handlers (like `save`, `speak`, and `autoGenerateIPA`) to avoid reading "stale" state from closures.

### State Shape

```
terms           []        All glossary terms (from Firestore)
search          ''        Current search input
selected        null      The original term object when entering detail view (reference copy)
localTerm       null      Working copy of the term being edited (detail view edits go here)
view            'list'    Current view: 'list', 'detail', or 'import'
tags            []        All unique tags across all terms (derived, kept in sync)
selectedTag     'all'     Active tag filter
loading         true      True only during initial data load (shows full-page spinner)
error           null      Error message string (shows full-page error screen)
newTag          ''        Text input for adding a new tag in detail view
importJson      ''        JSON textarea content in import view
importStatus    ''        Status message during import/cleanup operations
tagDropdownOpen false     Whether the tag filter dropdown is open
isGeneratingAudio false   True while ElevenLabs TTS request is in flight
fetchingIPA     false     True while auto-IPA fetch is in flight
flashId         null      Term ID to highlight after save (auto-clears after 2s)
```

### Key Refs

- `pendingAddRef` (`useRef`): Holds the promise from `addTerm` when a new term is being created. `save` awaits this if it's non-null to get the real Firestore ID before saving.
- `sRef` (`useRef`): Always points to the latest state object `s`. Used in asynchronous handlers (Save, Speak, Auto-IPA) to prevent stale state closures.

### Data Model (Firestore document)

```
id              string    Auto-generated by Firestore (doc ID, not stored as a field)
term            string    The vocabulary word
definition      string    Word definition
ipa             string    IPA pronunciation (e.g. "/ˈælɡərɪðəm/")
tags            string[]  Custom category tags
audioUrl        string    Firebase Storage URL to cached MP3
createdAt       timestamp Server timestamp
updatedAt       timestamp Server timestamp
userId          string    Reserved for future auth
```

## Views & Navigation

### Loading Screen
- Shown when `s.loading` is true (only during initial Firestore fetch on mount)
- Centered spinner with "Loading glossary..." text
- Max width: `max-w-xl`, centered

### Error Screen
- Shown when `s.error` is non-null (after loading completes)
- Shows the error message and a "Try Again" button that reloads the page

### List View (`s.view === 'list'`)

**Layout**: Full-screen flex column. Header, search bar, scrollable term list, bottom buttons, version footer.

**Header**:
- Title: "litgloss" (text-5xl bold, fade-in + slide-up animation, 1s duration)
- Subtitle: "Whitefriars 2026" (text-xl muted, same animation with 100ms delay)

**Search bar**:
- Search icon (left-inset) + text input, placeholder "Search"
- Filters terms client-side by matching against term name, definition, or tags (case-insensitive)
- **Enter key on search**: If search has text AND `getFilteredTerms()` returns zero matches, creates a new term pre-filled with the search text via `h.add(s.search)`. Automatically capitalizes the first letter.

**Tag filter dropdown** (only shown when tags exist):
- Button shows current filter ("All Tags" or selected tag name) with chevron icon
- Dropdown appears below-right, absolute positioned, z-50
- Options: "All Tags" + one button per unique tag
- Active filter uses `default` variant, others use `ghost`
- Closes on: selecting a tag, or clicking outside (mousedown listener on document via `.tag-dropdown` class check)

**Term list** (inside `ScrollArea`):
- Sorted alphabetically by term name (case-insensitive via `localeCompare` with `sensitivity: 'base'`)
- Each row shows:
  - **Play button** (Volume2 icon, 6x6, ghost variant): Only shown if `term.term` is truthy. Wrapped in a div with `stopPropagation` to prevent row click. Disabled while `isGeneratingAudio` is true. Calls `h.speak(term.term)`.
  - **Term name** (medium weight, base size) or "Untitled" if empty
  - **IPA** (monospace, muted, small) if present
  - **Definition preview** (muted, small, clamped to 2 lines) or "Tap to add definition" if empty
  - **Tag badges** (rounded pill, primary/10 bg, xs text, Tag icon) if tags exist
- **Click row**: Navigates to detail view, setting both `selected` and `localTerm` to the clicked term object
- **Flash highlight**: If `s.flashId` matches a term's ID, that row gets `bg-primary/20` class. Lasts 2 seconds. On flash, scrolls the element into view (smooth, centered) after a 100ms delay.
- **Empty state**: Shows "No terms yet" or "No matches - press Enter to create" (when search is active)
- **Gradient overlay**: 8px tall gradient at the bottom of the scroll area (from background to transparent, pointer-events-none)

**Bottom buttons**:
- "+ Add Term" (primary, flex-1): Calls `h.add()` with no argument
- "Import/Export" (outline, flex-1): Sets view to `'import'`

**Version footer**: "Version 10" centered, xs muted text

### Detail View (`s.view !== 'list' && s.view !== 'import'`)

**Layout**: Flex column, full width. Sticky header, scrollable form, fixed bottom bar, version footer.

**Header** (sticky top, z-10, border-bottom):
- **Back button** (ghost, ArrowLeft icon): Calls `h.goBack()`
- **Title** (centered, truncated, max-w-xs): Shows `s.localTerm?.term` or "New Term"

**Form** (p-4, space-y-4, max-w-xl centered):
- **Term input**: Height 12, text-lg font-medium, placeholder "Term"
- **IPA input**: Height 12, monospace, placeholder changes to "Fetching pronunciation..." when `fetchingIPA` is true, pulses with muted text. Has a Sparkles button (absolute right) that manually triggers IPA fetch. Button spins while fetching, disabled during fetch.
- **Definition textarea**: min-h-40, 10 rows, text-base, no resize
- **Tags section**:
  - Existing tags shown as rounded pills (primary/10 bg, Tag icon, X button to remove)
  - Add tag: text input (placeholder "Tag") + "Add" button (outline, sm). Button disabled if `newTag` is empty/whitespace. Enter key in input triggers `addTag`.

**Bottom bar** (border-top, p-4):
- **Delete button** (destructive): Opens an AlertDialog confirmation
  - Dialog title: "Are you sure?"
  - Dialog description: includes term name or "Untitled"
  - Cancel button + Delete button (destructive styling)
  - On confirm: Calls `h.deleteTerm(id)`. Navigates to list and clears selection/local state upon successful Firestore deletion.
- **Save button** (primary): Calls `h.save()`. Disabled when `s.loading` is true (only during initial load).

### Import/Export View (`s.view === 'import'`)

**Layout**: Full-screen flex column. Header, content area, version footer.

**Header**: Back button (ghost, navigates to list), centered title "Import Terms"

**Content**:
- **JSON format example**: Bordered card with a Copy button that copies example JSON to clipboard and shows success toast
- **JSON textarea**: Monospace, placeholder "Paste JSON here. Hint: Feed your word list to ChatGPT or Gemini as well as the template above...and it will poop out perfect JSON for you!"
- **Status alert**: Shown when `importStatus` is non-empty. Uses destructive variant if status contains a failure emoji.
- **Export button** (outline, Upload icon): Downloads all terms as JSON file named `litgloss-export-YYYY-MM-DD.json`. Strips `id` field from each term. Shows success toast.
- **Import button** (primary, Download icon): Disabled if textarea is empty. Parses JSON, auto-capitalizes terms/definitions, auto-fetches IPA for terms missing it, adds each term to Firestore sequentially with progress status. After completion, refetches all terms from Firestore. Shows success/error toast.
- **Maintenance tools**:
  - **Capitalize All**: Iterates through all terms in Firestore and capitalizes the first letter of every term and definition if they aren't already.
  - **Cleanup Blanks**: Deletes any terms from Firestore that are empty, whitespace-only, or named "Untitled".

## Feature Behaviors

### Adding a Term (`h.add`)
1. Generates a temporary ID (`Date.now().toString()`)
2. Creates term with `{ term: capitalizedSearchTerm, definition: "", ipa: "", tags: [] }`
3. Optimistically adds to state: prepends to `terms`, sets `selected`, `localTerm`, switches to detail view
4. If called with a search term, clears the search input
5. Fires `glossaryService.addTerm()` asynchronously, stored in `pendingAddRef.current`
6. When Firestore responds with the real ID, updates the temp ID in `terms`, `selected`, and `localTerm` (preserving any edits the user has made)
7. On failure: removes the optimistic term, navigates back to list, shows error

### Editing a Term (Detail View)
- All edits are local only (stored in `s.localTerm`), nothing is persisted until explicit Save or Back
- `selected` retains the original term data as loaded from the list; `localTerm` is the working copy
- `inputChange` uses a functional state updater to avoid stale closure issues
- **Auto-Capitalization**: First letter of Term and Definition fields are automatically capitalized on every keystroke.

### Auto-IPA Generation
- **Trigger**: When typing in the term field, if the trimmed value is >2 characters AND the IPA field is currently empty.
- **Debounce**: 1500ms (stable across renders via `useCallback` + `[]` deps).
- **Source**: Free Dictionary API (`dictionaryapi.dev`), looks for `entry.phonetic` first, then iterates `entry.phonetics[].text`.
- **Guard**: Before applying, verifies the term still matches the fetched word AND the IPA field is still empty (prevents overwriting user-typed or existing IPA).
- **UI feedback**: `fetchingIPA` flag controls placeholder text ("Fetching pronunciation..."), input pulse animation, and sparkles button spin.
- **Manual trigger**: Sparkles button in the IPA input calls `autoGenerateIPA` directly. It still respects the empty-IPA guard inside `autoGenerateIPA` to prevent accidental overwrites, but ignores the >2 char condition.

### Saving a Term (`h.save`)
1. Exits early if `s.selected?.id` is falsy
2. Captures `s.localTerm` as the data to save
3. **Auto-adds pending tag**: If `s.newTag` has text, appends it to the tags array (prevents losing a tag the user typed but didn't click "Add" for)
4. **Auto-wraps IPA**: If IPA text exists, ensures it starts and ends with `/`
5. **Awaits pending add**: If `pendingAddRef.current` is non-null, awaits it to get the real Firestore ID
6. Strips the `id` field from the save payload before sending to Firestore
7. On success: updates the term in `terms` array, clears `selected`/`localTerm`/`newTag`, sets `view: 'list'`, sets `flashId` for highlight, recomputes `tags`, shows success toast
8. On failure: shows error toast (stays on detail view)

### Back Button (`h.goBack`)
1. Reads `s.localTerm` (falling back to `s.selected`)
2. **Blank check**: Term is considered blank if ALL of: term is empty/whitespace, definition is empty/whitespace, IPA is empty/whitespace, tags array is empty
3. If blank AND has an ID: removes from `terms` state, fires async Firestore delete (fire-and-forget), navigates to list
4. If not blank AND has an ID: calls `await h.save()` (auto-save on back)
5. Otherwise: navigates to list

### Escape Key (global keydown handler, capture phase)
1. Blurs the active element (if not body)
2. On detail view: same blank-check logic as Back, but does NOT auto-save. If blank, deletes and navigates to list. If not blank, discards changes and navigates to list. Clears `selected` and `localTerm`.
3. On import view: navigates to list
4. On list view: no action

**Key difference from Back button**: Escape discards unsaved changes; Back auto-saves.

### Deleting a Term (`h.delete`)
1. Calls `glossaryService.deleteTerm(termId)` (awaited)
2. On success: removes term from `terms`, recomputes `tags`
3. On failure: sets error message
4. The AlertDialog confirm handler also immediately navigates to list (doesn't wait for delete to complete)

### Text-to-Speech (`h.speak`)
1. Accepts string (term name from list), object (term obj), or null (uses `s.localTerm`)
2. If passed a string, looks up the term object in `s.terms` by name match to check for cached audio
3. **Cached audio**: If `termObj.audioUrl` exists, plays it directly via `new Audio(url)` and returns
4. **Generate new audio**: Requires `VITE_ELEVENLABS_API_KEY` env var
   - API: ElevenLabs, voice ID `IKne3meq5aSn9XLyUdCD`, model `eleven_turbo_v2_5`
   - Voice settings: stability 0.3, similarity_boost 0.3, style 0.2, speaker_boost on
   - Plays immediately via object URL on `onloadeddata`
   - **Caches to Firebase Storage**: If term has a real (non-temp) ID, uploads MP3 to `audio/{id}.mp3`, gets download URL, updates Firestore and local state
5. `isGeneratingAudio` flag prevents concurrent requests and disables play buttons globally

### Tag Management
- **Add tag** (`h.addTag`): Trims the `newTag` input, skips if empty or duplicate, appends to `localTerm.tags`, clears `newTag`. Can trigger via Enter key in tag input or clicking Add button.
- **Remove tag** (`h.removeTag`): Filters the tag out of `localTerm.tags`
- **Tag filter dropdown**: Filters the list view to show only terms containing the selected tag. "All Tags" shows everything.
- **Global tag list** (`s.tags`): Recomputed from all terms whenever terms change (on load, save, delete, import). Sorted alphabetically. Deduped via `Set`.

### Import
1. Parses JSON from textarea (expected: array of term objects)
2. For each term missing IPA, fetches it from Free Dictionary API
3. Adds each term to Firestore sequentially
4. Shows progress: "Importing... (N/total)"
5. After all imports, refetches all terms from Firestore to sync state
6. Shows success toast with count, clears textarea and status

### Export
1. Maps all terms, stripping `id` field (keeps all other fields including `createdAt`, `audioUrl`, etc.)
2. Downloads as JSON file via temporary `<a>` element
3. Filename: `litgloss-export-YYYY-MM-DD.json`

### Bulk Operations

**Capitalize All** (`h.capitalizeAllEntries`):
- Iterates through all terms in the current state.
- Trims and capitalizes the first letter of both `term` and `definition` if changes are needed.
- Updates Firestore and refreshes local state.
- Provides progress feedback via `importStatus`.

**Cleanup Blank Entries** (`h.cleanupBlankEntries`):
- Finds terms where `term` is empty, whitespace-only, or "Untitled".
- Deletes each from Firestore sequentially.
- Refetches all terms after completion.
- Provides progress feedback via `importStatus`.

## Firestore Service (`glossaryService`)

- **getAllTerms**: Tries `orderBy('createdAt', 'desc')` first. Falls back to client-side sort if index is missing (`failed-precondition`). Client sort: by `createdAt.toMillis()` desc, then by `id` string comparison.
- **getTermsByTag**: Same pattern with `where('tags', 'array-contains', tag)` + orderBy fallback. Not currently used by the UI (filtering is client-side).
- **searchTerms**: Fetches all terms, filters client-side. Not currently used by the UI (filtering is inline in `getFilteredTerms`).
- **addTerm**: Adds doc with `serverTimestamp()` for `createdAt`/`updatedAt`, ensures `tags` defaults to `[]`. Returns the new doc ID.
- **updateTerm**: Updates doc fields + `updatedAt: serverTimestamp()`. Receives data without the `id` field.
- **deleteTerm**: Deletes doc by ID. Silent if doc doesn't exist.
- **getAllTags**: Fetches all docs, extracts and dedupes tags. Not currently used (tags are derived in-app).
- **getIPA**: Fetches from `api.dictionaryapi.dev`, URL-encodes and lowercases the word. Returns first found IPA string or null. Never throws (catches errors internally).

## Styling & Layout

- App container: `max-w-xl mx-auto min-h-screen`
- List view: `h-screen` with flex layout
- Detail view header: `sticky top-0 z-10`
- Detail form: `max-w-xl mx-auto` (constrained within detail view)
- Animations: `animate-in fade-in slide-in-from-bottom-4 duration-1000` on title/subtitle
- Flash highlight: `bg-primary/20` with `transition-all duration-1000`
- CSS custom properties for all theme colors (light/dark mode defined but dark mode not currently togglable in UI)
- Custom utilities: `line-clamp-2`, `scrollbar-hide`

## Environment Variables

- `VITE_ELEVENLABS_API_KEY`: Required for text-to-speech. If missing, speak silently fails with console error.

## Build & Dev

- `npm run dev` / `bun dev`: Local dev server
- `npm run build`: Production build to `dist/`
- `npm run start`: Dev server on `0.0.0.0` (network accessible)
- Deployed via Firebase Hosting (`firebase.json`)
## Component Update: Professional Specialist Footer

Update the site footer to a "Boutique Specialist" aesthetic using the **Pace UI** extension for **shadcn/ui**.

### 1. Layout & Theme
- **Structure:** Three-column grid (`grid-cols-3`) with `items-center`.
- **Styling:** Subtle top border (`border-t`), airy vertical padding (`py-10`).
- **Responsiveness:** Stack columns vertically and center-align on mobile screens.
- **Tokens:** Use CSS variables (`--background`, `--muted-foreground`) to ensure theme consistency.

### 2. Left Column: The Specialist (Scramble Effect)
- **Content:** Stack **"Ben Hinton, MA"** (text-lg, font-bold) above **"Language Specialist"** (text-xs, uppercase, tracking-widest, text-muted-foreground).
- **Component:** Wrap both in the Pace UI `<ScrambleText />` primitive.
- **Config:** - `characters`: Use linguistic/logical symbols `X, Z, #, @, &, 0, 1, {`.
  - `trigger`: Animate on hover.

### 3. Center Column: The Release
- **Content:** **"Version 12 (Whitefriars)"**
- **Styling:** Small, muted monospace font (`font-mono`). Must be perfectly centered as the UI anchor.

### 4. Right Column: Contact CTA
- **Component:** Render the email inside a shadcn `<Badge variant="outline" />` with a refined hover state.
- **Email:** `vce.specialist@icloud.com`
- **Functionality:** Use a pre-populated `mailto:` link:
  `mailto:vce.specialist@icloud.com?subject=VCE%20Inquiry%20-%20Whitefriars&body=Hi%20Ben,%20I'm%20using%20your%20VCE%20website%20and%20would%20love%20to%20chat%20about%20tutoring.`

### 5. Deployment Workflow
- **Commit:** After styling, commit all changes with message "feat: implement v12 specialist footer with pace ui scramble".
- **Push:** Push changes to `main`.
- **Monitor:** Run `netlify watch` to tail the build and confirm the site is live.